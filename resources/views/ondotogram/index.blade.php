@extends('layouts.topnavlayout')
@section('title','Kelola Data Ondotogram')
@section('content')
<div class="content-wrapper">
  <section class="content-header">
    <h1>
      Kelola Data Ondotogram
      <small></small>
    </h1>
    <ol class="breadcrumb">
      <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
      <li class="active">Dashboard</li>
    </ol>
  </section>


  <section class="content">
    <div class="row">
      <div class="col-xs-12">
        <div class="box">

          <div class="box-body">
            <h4 class="text-center">ONDOTOGRAM</h4>  
            <div>
              <table id="Table_01" style="transform:scale(.8)" height="680" border="0" cellpadding="0" cellspacing="0">
                <tr>
                  <td>
                    <img data-kode="18" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_01.gif" width="151" height="181" alt=""></td>
                  <td>
                    <img data-kode="17" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_02.gif" width="72" height="181" alt=""></td>
                  <td>
                    <img data-kode="16" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_03.gif" width="74" height="181" alt=""></td>
                  <td>
                    <img data-kode="15" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_04.gif" width="73" height="181" alt=""></td>
                  <td>
                    <img data-kode="14" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_05.gif" width="72" height="181" alt=""></td>
                  <td>
                    <img data-kode="13" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_06.gif" width="74" height="181" alt=""></td>
                  <td>
                    <img data-kode="12" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_07.gif" width="75" height="181" alt=""></td>
                  <td>
                    <img data-kode="11" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_08.gif" width="72" height="181" alt=""></td>
                  <td>
                    <img data-kode="21" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_09.gif" width="74" height="181" alt=""></td>
                  <td>
                    <img data-kode="22" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_10.gif" width="71" height="181" alt=""></td>
                  <td>
                    <img data-kode="23" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_11.gif" width="76" height="181" alt=""></td>
                  <td>
                    <img data-kode="24" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_12.gif" width="71" height="181" alt=""></td>
                  <td>
                    <img data-kode="25" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_13.gif" width="78" height="181" alt=""></td>
                  <td>
                    <img data-kode="26" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_14.gif" width="69" height="181" alt=""></td>
                  <td>
                    <img data-kode="27" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_15.gif" width="76" height="181" alt=""></td>
                  <td>
                    <img data-kode="28" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_16.gif" width="162" height="181" alt=""></td>
                </tr>
                <tr>
                  <td colspan="4">
                    <img data-kode="55" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_17.gif" width="370" height="166" alt=""></td>
                  <td>
                    <img data-kode="54" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_18.gif" width="72" height="166" alt=""></td>
                  <td>
                    <img data-kode="53" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_19.gif" width="74" height="166" alt=""></td>
                  <td>
                    <img data-kode="52" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_20.gif" width="75" height="166" alt=""></td>
                  <td>
                    <img data-kode="51" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_21.gif" width="72" height="166" alt=""></td>
                  <td>
                    <img data-kode="61" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_22.gif" width="74" height="166" alt=""></td>
                  <td>
                    <img data-kode="62" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_23.gif" width="71" height="166" alt=""></td>
                  <td>
                    <img data-kode="63" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_24.gif" width="76" height="166" alt=""></td>
                  <td>
                    <img data-kode="64" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_25.gif" width="71" height="166" alt=""></td>
                  <td colspan="4">
                    <img data-kode="65" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_26.gif" width="385" height="166" alt=""></td>
                </tr>
                <tr>
                  <td colspan="4">
                    <img data-kode="85" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_27.gif" width="370" height="155" alt=""></td>
                  <td>
                    <img data-kode="84" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_28.gif" width="72" height="155" alt=""></td>
                  <td>
                    <img data-kode="83" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_29.gif" width="74" height="155" alt=""></td>
                  <td>
                    <img data-kode="82" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_30.gif" width="75" height="155" alt=""></td>
                  <td>
                    <img data-kode="81" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_31.gif" width="72" height="155" alt=""></td>
                  <td>
                    <img data-kode="71" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_32.gif" width="74" height="155" alt=""></td>
                  <td>
                    <img data-kode="72" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_33.gif" width="71" height="155" alt=""></td>
                  <td>
                    <img data-kode="73" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_34.gif" width="76" height="155" alt=""></td>
                  <td>
                    <img data-kode="74" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_35.gif" width="71" height="155" alt=""></td>
                  <td colspan="4">
                    <img data-kode="75" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_36.gif" width="385" height="155" alt=""></td>
                </tr>
                <tr>
                  <td>
                    <img data-kode="48" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_37.gif" width="151" height="178" alt=""></td>
                  <td>
                    <img data-kode="47" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_38.gif" width="72" height="178" alt=""></td>
                  <td>
                    <img data-kode="46" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_39.gif" width="74" height="178" alt=""></td>
                  <td>
                    <img data-kode="45" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_40.gif" width="73" height="178" alt=""></td>
                  <td>
                    <img data-kode="44" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_41.gif" width="72" height="178" alt=""></td>
                  <td>
                    <img data-kode="43" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_42.gif" width="74" height="178" alt=""></td>
                  <td>
                    <img data-kode="42" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_43.gif" width="75" height="178" alt=""></td>
                  <td>
                    <img data-kode="41" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_44.gif" width="72" height="178" alt=""></td>
                  <td>
                    <img data-kode="31" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_45.gif" width="74" height="178" alt=""></td>
                  <td>
                    <img data-kode="32" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_46.gif" width="71" height="178" alt=""></td>
                  <td>
                    <img data-kode="33" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_47.gif" width="76" height="178" alt=""></td>
                  <td>
                    <img data-kode="34" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_48.gif" width="71" height="178" alt=""></td>
                  <td>
                    <img data-kode="35" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_49.gif" width="78" height="178" alt=""></td>
                  <td>
                    <img data-kode="36" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_50.gif" width="69" height="178" alt=""></td>
                  <td>
                    <img data-kode="37" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_51.gif" width="76" height="178" alt=""></td>
                  <td>
                    <img data-kode="38" class="kode-gigi" src="{{ asset('images') }}/141686611-90067e00-8288-4e3d-842e-392adb7c9080_52.gif" width="162" height="178" alt=""></td>
                </tr>
              </table>
            </div>          
            @if($total != 0)
            <a class="btn btn-danger btn-sm" style="margin-top:15px" href="{{ url('ondotogram/' . Request::segment(2) . '/print') }}" target="_blank"><i class="fa fa-print" aria-hidden="true"></i> Cetak Hasil</a>
            @endif
            <hr>
            <table class="table table-bordered">
                <thead>
                  <tr>
                    <th width="15">NOMOR</th>
                    <th>GIGI</th>
                    <th>Kondisi</th>
                    <th>Anamnesa</th>
                    <th>Tindakan</th>
                    <th>Action</th>
                  </tr>
                </thead>
                @if(count($pendaftaran_gigi) != 0)
                <tbody class="ondotogram-output">
                  @foreach($pendaftaran_gigi as $p)
                  <tr class="data-ondotogram">
                    <td>{{ $loop->iteration }}</td>
                    <td>{{ $p->kode_gigi }}</td>
                    <td>{{ $p->tbm->indonesia }}</td>
                    <td>{{ $p->anamnesa }}</td>
                    <td>{{ $p->tindakan->tindakan }}</td>
                    <td>
                      <button class="btn btn-danger btm-sm hapus" data-id="{{ $p->id }}">Hapus</button>
                    </td>
                  </tr>
                  @endforeach
                </tbody>
                @else 
                <tbody class="ondotogram-output">
                  <tr class="enough">
                    <td colspan="6" class="text-center"><h3>Hasil pemeriksaan belum ada</h3></td>
                  </tr>
                </tbody>
                @endif
              </table>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>
<div class="modal fade" id="modal-default">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Kondisi Gigi Pasien {{ $pendaftaran->kode }} / Gigi-<span id="kodeGigi"></span></h4>
      </div>
      <form action="#">
        <input type="hidden" id="pendaftaranId" class="form-control" value="{{ $pendaftaran->id }}">
        <div class="modal-body">
          <div class="row">
              <div class="col-md-4">
                <label for="">Kondisi / Pemeriksaan</label>
              </div>
              <div class="col-md-8">
                  <div class="form-group">
                    <select name="tbm_icd_id" id="tbm" class="tbm-icd form-control" style="height: 100px;width: 100%" placeholder="Masukan Nama Tbm"></select>
                  </div>
              </div>
              <div class="col-md-4">
                <label for="">Anamnesa</label>
              </div>
              <div class="col-md-8">
                  <div class="form-group">
                      <input type="text" id="anamnesa" class="form-control" placeholder="Masukan anamnesa">
                  </div>
              </div>
              <div class="col-md-4">
                <label for="">Tindakan</label>
              </div>
              <div class="col-md-8">
                  <div class="form-group">
                    <select name="tindakan_id" id="tindakan_id" class="tindakan form-control" style="height: 100px;width: 100%" placeholder="Pilih Tindakan"></select>
                  </div>
              </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Close</button>
          <button type="button" id="submit" class="btn btn-primary">Save changes</button>
        </div>
      </form>
    </div>
    <!-- /.modal-content -->
  </div>
  <!-- /.modal-dialog -->
</div>

<input type="hidden" id="total" value="{{ $total }}"/>
<!-- /.modal -->
@endsection

@push('scripts')
<script src="{{asset('adminlte/bower_components/select2/dist/js/select2.min.js')}}"></script>
<script>
$( document ).ready(function() {

  // Handle nomor field after ajax
  let total = parseInt($("#total").val());

  // Select2 from table tbm_icd where dtd like K00
  $('.tbm-icd').select2({
      placeholder: 'Pilih Kondisi Gigi',
      ajax: {
      url: '/ajax/select2TBM',
      dataType: 'json',
      delay: 250,
      processResults: function (data) {
          return {
          results:  $.map(data, function (item) {
              return {
              text: item.indonesia,
              id: item.id
              }
          })
          };
      },
      cache: true
      }
  });

  // Select2 from table tindakan where dtd like K00
  $('.tindakan').select2({
      placeholder: 'Pilih Tindakan',
      ajax: {
      url: '/ajax/select2Tindakan',
      dataType: 'json',
      delay: 250,
      processResults: function (data) {
          return {
          results:  $.map(data, function (item) {
              return {
              text: item.tindakan,
              id: item.id
              }
          })
          };
      },
      cache: true
      }
  });

  $('#submit').on('click', function() {
    // Get data form
    let tbm_icd_id = $('#tbm').val()
    let anamnesa = $('#anamnesa').val()
    let tindakan_id = $('#tindakan_id').val()
    let pendaftaran_id = $('#pendaftaranId').val()

    // Create payload for ajax request
    payload = {
      "_token": "{{ csrf_token() }}",
      tbm_icd_id,
      anamnesa,
      tindakan_id,
      pendaftaran_id,
      kode_gigi
    };

    // Request AJAX
    $.ajax({
      method: 'POST',
      url: '/ondotogram',
      data: payload,
      success: function(res) {
        console.log(res);
        $('#tbm').val(null)
        $('#anamnesa').val(null)
        $('#tindakan').val(null)
        $('#modal-default').modal('toggle')

        total++;

        let content = `
          <tr>
            <td>${total}</td>
            <td>${res.data.kode_gigi}</td>
            <td>${res.data.tbm.indonesia}</td>
            <td>${res.data.anamnesa}</td>
            <td>${res.data.tindakan.tindakan}</td>
            <td><button class='btn btn-danger hapus' data-id='${res.data.id}' }}''>Hapus</button></td>
          </tr>
        `;  

        $('.enough').remove()
        $('.ondotogram-output').append(content);
      },
      error: function(err) {
        console.log(err);
      }
    })
  })

  // Handle ondotogram image onclick
  let kode_gigi = ""
  $('.kode-gigi').on('click', function() {
    kode_gigi = $(this).attr('data-kode')
    $('#kodeGigi').html(kode_gigi)
    $('#modal-default').modal({show: true})
  });

  // Handle hapus data
  $('.hapus').on('click', function() {
    if(confirm("Apakah anda yakin akan menghapus?")) {
      let el = $(this).closest('.data-ondotogram')
      let id = $(this).attr('data-id')
      let url = "{{ url('ondotogram') }}/" + id

      payload = {
        "_token": "{{ csrf_token() }}",
      }

      $.ajax({
        method: 'POST',
        url: url,
        data: payload,
        success: function(res) {
          el.remove()
        }
      })

      } else {
        return false;
      }
  })
});
</script>
@endpush

@push('css')
    <link href="{{asset('adminlte/bower_components/select2/dist/css/select2.min.css')}}" rel="stylesheet"/>
@endpush